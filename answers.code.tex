\ExplSyntaxOn

% Useful to know this
\DeclareDocumentCommand \MaxInt {}
{
  \int_use:N \c_max_int
}
\DeclareDocumentCommand \MaxIntarray {}
{
  \int_eval:n {\c_max_int/2 - 1}
}

% Variants of standard functions

\cs_generate_variant:Nn \file_get:nnNT {VnNT}
\cs_generate_variant:Nn \iow_open:Nn {NV}
\cs_generate_variant:Nn \tl_if_in:nnTF {Vn}
\cs_generate_variant:Nn \tl_if_in:nnT {Vn}
\cs_generate_variant:Nn \tl_if_in:nnF {Vn}
\cs_generate_variant:Nn \tl_if_eq:nnTF {Vn}
\cs_generate_variant:Nn \tl_if_eq:nnT {Vn}
\cs_generate_variant:Nn \tl_if_eq:nnF {Vn}
\cs_generate_variant:Nn \prop_put:Nnn {Nxn}
\cs_generate_variant:Nn \prop_item:Nn {Nx}
\cs_generate_variant:Nn \prop_get:NnN {NxN}

% These are our output stack variables
\tl_new:N \g__aoc_output_tl
\int_new:N \g__aoc_output_int
\seq_new:N \g__aoc_output_seq
\bool_new:N \g__aoc_output_bool
\prop_new:N \g__aoc_output_prop

% To avoid creating vast numbers of variables, we provide ourselves with a few that we reuse frequently.
% For that reason, most of them don't have very exciting names.

% These are general purpose variables.
\tl_new:N \l__aoc_tmpa_tl
\tl_new:N \l__aoc_tmpb_tl
\tl_new:N \l__aoc_tmpc_tl
\tl_new:N \l__aoc_tmpd_tl
\tl_new:N \l__aoc_tmpe_tl
\tl_new:N \l__aoc_tmpf_tl
\tl_new:N \l__aoc_tmpg_tl
\tl_new:N \l__aoc_tmph_tl
\tl_new:N \l__aoc_tmpi_tl

\str_new:N \l__aoc_tmpa_str
\str_new:N \l__aoc_tmpb_str
\str_new:N \l__aoc_tmpc_str

\seq_new:N \l__aoc_tmpa_seq
\seq_new:N \l__aoc_tmpb_seq
\seq_new:N \l__aoc_tmpc_seq
\seq_new:N \l__aoc_tmpd_seq
\seq_new:N \l__aoc_tmpe_seq
\seq_new:N \l__aoc_tmpf_seq

\dim_new:N \l__aoc_tmpa_dim
\dim_new:N \l__aoc_tmpb_dim

\fp_new:N \l__aoc_tmpa_fp
\fp_new:N \l__aoc_tmpb_fp
\fp_new:N \l__aoc_tmpc_fp
\fp_new:N \l__aoc_tmpd_fp
\fp_new:N \l__aoc_tmpe_fp
\fp_new:N \l__aoc_tmpf_fp

\int_new:N \l__aoc_tmpa_int
\int_new:N \l__aoc_tmpb_int
\int_new:N \l__aoc_tmpc_int
\int_new:N \l__aoc_tmpd_int
\int_new:N \l__aoc_tmpe_int
\int_new:N \l__aoc_tmpf_int
\int_new:N \l__aoc_tmpg_int

\bool_new:N \l__aoc_tmpa_bool
\bool_new:N \l__aoc_tmpb_bool

\ior_new:N \l__aoc_tmpa_ior
\iow_new:N \l__aoc_tmpa_iow

\prop_new:N \l__aoc_tmpa_prop
\prop_new:N \l__aoc_tmpb_prop
\prop_new:N \l__aoc_tmpc_prop

\msg_new:nnn
{ advent }
{ missing file }
{ File~ #1~ doesn't~ exist~ \msg_line_context:}


% Additional data structures

% Grid structure is linearised to an intarray, therefore has to be
% global.  Store the dimensions in the first two elements so then
% everything else needs an offset of 2
%
% Now, I think of an (m,n) matrix as having m rows and n columns, so
% the (i,j)th element is in the ith row and the jth column.  We'll
% define a grid using the row-major convention since the likelihood is
% that the grid will be read in from a file.
%
% intarray's are 1-based, so the grids are also 1-based.  So given a
% pair (i,j), the corresponding index is:
%
% n*(i-1) + j
%
% It needs a check to ensure that i and j are within the required range

\msg_new:nnn
{ advent }
{ grid range }
{ Index~ #1~ out~ of~ range~ at~ \msg_line_context:}

\cs_new_protected_nopar:Npn \grid_new:Nnn #1#2#3
{
  \intarray_new:Nn #1 {(#2)*(#3) + 2}
  \intarray_gset:Nnn #1 {1} {#2} % Number of rows
  \intarray_gset:Nnn #1 {2} {#3} % Number of columns
}

\cs_generate_variant:Nn \grid_new:Nnn {NVV}

% Clear a grid, but keep the dimensions
\cs_new_protected_nopar:Npn \grid_gclear:N #1
{
  \group_begin:
  \int_set:Nn \l__aoc_tmpa_int {\intarray_item:Nn #1 {1}}
  \int_set:Nn \l__aoc_tmpb_int {\intarray_item:Nn #1 {2}}
  \intarray_gzero:N #1
  \intarray_gset:Nnn #1 {1} {\l__aoc_tmpa_int}
  \intarray_gset:Nnn #1 {2} {\l__aoc_tmpb_int}
  \group_end:
}

% Set an element, but check the range
\cs_new_protected_nopar:Npn \grid_gset:Nnnn #1#2#3#4
{
  \grid_if_in_range:NnnTF #1{#2}{#3}
  {
    \intarray_gset:Nnn #1
    {
      (\intarray_item:Nn #1 {2}) * (#2 - 1)
      +
      (#3)
      +
      2
    }
    {
      #4
    }
  }
  {
    \msg_warning:nnn { advent } { grid range } { (#2,#3) }
  }
}

\cs_generate_variant:Nn \grid_gset:Nnnn {NVVn, NnnV, NVVV}


% Get an element, but check the range
\cs_new_protected_nopar:Npn \grid_item:Nnn #1#2#3
{
  \grid_if_in_range:NnnTF #1{#2}{#3}
  {
    \intarray_item:Nn #1
    {
      (\intarray_item:Nn #1 {2}) * (#2 - 1)
      +
      (#3)
      +
      2
    }
  }
  {
    \msg_warning:nnn { advent } { grid range } { (#2,#3) }
  }
}

% Get an element into an integer register, but check the range
\cs_new_protected_nopar:Npn \grid_item:NNnn #1#2#3#4
{
  \grid_if_in_range:NnnTF #2{#3}{#4}
  {
    \int_set:Nn #1
    {
      \intarray_item:Nn #2
      {
        (\intarray_item:Nn #2 {2}) * (#3 - 1)
        +
        (#4)
        +
        2
      }
    }
  }
  {
    \msg_warning:nnn { advent } { grid range } { (#3,#4) }
  }
}

\cs_generate_variant:Nn \grid_item:Nnn {NVV}

% Get the number of rows or columns
\cs_new_protected_nopar:Npn \grid_rows:N #1
{
  \intarray_item:Nn #1 {1}
}
\cs_new_protected_nopar:Npn \grid_columns:N #1
{
  \intarray_item:Nn #1 {2}
}

% Check range
\prg_new_protected_conditional:Npnn \grid_if_in_range:Nnn #1#2#3 {T,F,TF}
{
  \bool_if:nTF
  {
    \int_compare_p:n {1 <= #2}
    &&
    \int_compare_p:n {#2 <= \intarray_item:Nn #1 {1} } % Number of rows
    &&
    \int_compare_p:n {1 <= #3}
    &&
    \int_compare_p:n {#3 <= \intarray_item:Nn #1 {2} } % Number of columns
  }
  {
    \prg_return_true:
  }
  {
    \prg_return_false:
  }
}

% Show a grid
\cs_new_protected_nopar:Npn \grid_show:N #1
{
  \group_begin:
  \iow_term:x {The~ grid~ \token_to_str:N #1~ contains:}
  \int_step_inline:nnn {1} {\grid_rows:N #1}
  {
    \tl_clear:N \l__aoc_tmpa_tl
    \int_step_inline:nnn {1} {\grid_columns:N #1}
    {
      \grid_item:NNnn \l__aoc_tmpa_int #1 {##1} {####1}
      \tl_put_right:Nx \l__aoc_tmpa_tl {,\int_use:N \l__aoc_tmpa_int}
    }
    \tl_set:Nx \l__aoc_tmpa_tl {\tl_tail:N \l__aoc_tmpa_tl}
    \iow_term:x {\tl_use:N \l__aoc_tmpa_tl}
  }
  \group_end:
}

% Caching

\prop_new:N \g__aoc_answers_prop
\tl_new:N \g__aoc_answers_file_tl
\tl_gset:Nn \g__aoc_answers_file_tl {2022_answers}
\tl_gput_right:Nn \g__aoc_answers_file_tl {.txt}


\file_get:VnNT \g__aoc_answers_file_tl {} \l__aoc_tmpa_tl
{
  \tl_use:N \l__aoc_tmpa_tl
}

\prop_gremove:Nn \g__aoc_answers_prop {Template}

\AddToHook {enddocument} 
{
  \iow_open:NV \l__aoc_tmpa_iow \g__aoc_answers_file_tl
  \prop_map_inline:Nn \g__aoc_answers_prop
  {
    \iow_now:Nn \l__aoc_tmpa_iow
    {
      \prop_gput:Nnn \g__aoc_answers_prop {#1} {#2}
    }
  }
  \iow_close:N \l__aoc_tmpa_iow
}

% Clear the outputs
\cs_new_protected_nopar:Npn \aoc_clear_outputs:
{
  \tl_gclear:N \g__aoc_output_tl
  \int_gzero:N \g__aoc_output_int
  \seq_gclear:N \g__aoc_output_seq
  \bool_gset_false:N \g__aoc_output_bool
  \prop_gclear:N \g__aoc_output_prop
}


\tl_const:Nn \c__aoc_tl_tl {tl}
\tl_const:Nn \c__aoc_int_tl {int}
\tl_const:Nn \c__aoc_seq_tl {seq}
\tl_const:Nn \c__aoc_bool_tl {bool}
\tl_const:Nn \c__aoc_prop_tl {prop}
\bool_new:N \g__aoc_regenerate_next_bool

\cs_new_protected_nopar:Npn \aoc_check_answer:nnn #1#2#3
{
  \group_begin:
  \tl_set:Nn \l__aoc_tmpb_tl {#1}
  \bool_if:nTF
  {
    !\g__aoc_regenerate_next_bool
    &&
    \prop_if_in_p:Nn \g__aoc_answers_prop {#2}
  }
  {
    \prop_get:NnN \g__aoc_answers_prop {#2} \l__aoc_tmpa_tl
    \tl_case:Nn \l__aoc_tmpb_tl
    {
      \c__aoc_tl_tl {\tl_gset_eq:NN \g__aoc_output_tl \l__aoc_tmpa_tl}
      \c__aoc_int_tl {\int_gset:Nn \g__aoc_output_int {\tl_use:N \l__aoc_tmpa_tl}}
      \c__aoc_seq_tl {\exp_args:NNV\seq_gset_from_clist:Nn \g__aoc_output_seq \l__aoc_tmpa_tl}
    }
  }
  {
    \iow_log:n {Calculating~ solution~ for~ #2.}
    #3
    \tl_case:Nn \l__aoc_tmpb_tl
    {
      \c__aoc_tl_tl {\prop_gput:NnV \g__aoc_answers_prop {#2} \g__aoc_output_tl}
      \c__aoc_int_tl {\prop_gput:NnV \g__aoc_answers_prop {#2} \g__aoc_output_int}
      \c__aoc_seq_tl
      {
        \prop_gput:Nnx \g__aoc_answers_prop {#2} {\seq_use:Nn \g__aoc_output_seq {,}}
      }
    }
  }
  \bool_gset_false:N \g__aoc_regenerate_next_bool
  \group_end:
}
\cs_generate_variant:Nn \_aoc_check_answer:nnn {nVn,nxn}





% Day 01: Counting Calories
\cs_new_protected_nopar:Npn \aoc_max_calories:n #1
{
  \group_begin:
  % Try to open the file
  \ior_open:NnTF \l__aoc_tmpa_ior {#1 .txt}
  {
    % That was successful, so now initialise our variables.
    % We have an integer that carries the current count of calories and then a sequence that stores the current top three counts.
    \int_zero:N \l__aoc_tmpa_int
    \seq_clear:N \l__aoc_tmpa_seq
    \seq_put_right:Nn \l__aoc_tmpa_seq {0}
    \seq_put_right:Nn \l__aoc_tmpa_seq {0}
    \seq_put_right:Nn \l__aoc_tmpa_seq {0}

    \ior_map_inline:Nn \l__aoc_tmpa_ior
    {
      \tl_if_eq:nnTF {##1} {\par}
      {
        % Add our current count to the sequence
        \seq_put_right:NV \l__aoc_tmpa_seq \l__aoc_tmpa_int
        % Sort the sequence
        \seq_sort:Nn \l__aoc_tmpa_seq {
          \int_compare:nNnTF { ####1 } > { ####2 }
          { \sort_return_swapped: }
          { \sort_return_same: }
        }
        % Remove the lowest
        \seq_pop_left:NN \l__aoc_tmpa_seq \l__aoc_tmpa_tl
        % Zero the count
        \int_zero:N \l__aoc_tmpa_int
      }
      {
        \int_add:Nn \l__aoc_tmpa_int {##1}
      }
    }      
    % Add our current count to the sequence
    \seq_put_right:NV \l__aoc_tmpa_seq \l__aoc_tmpa_int
    % Sort the sequence
    \seq_sort:Nn \l__aoc_tmpa_seq {
      \int_compare:nNnTF { ##1 } > { ##2 }
      { \sort_return_swapped: }
      { \sort_return_same: }
    }
    % Remove the lowest
    \seq_pop_left:NN \l__aoc_tmpa_seq \l__aoc_tmpa_tl
    \seq_gset_eq:NN \g__aoc_output_seq \l__aoc_tmpa_seq
    \ior_close:N \l__aoc_tmpa_ior
  }
  {
    % If there was a problem with the file
    \msg_warning:nnn { advent } { missing file } {#1}
  }
  \group_end:
}

\DeclareDocumentCommand \MaxCalories { s m }
{
  \aoc_check_answer:nnn {seq} {Calories}
  {
    \aoc_max_calories:n {#2}
  }

  \int_zero:N \l__aoc_tmpa_int
  \IfBooleanTF {#1}
  {
    \int_set:Nn \l__aoc_tmpa_int
    {
      \seq_item:Nn \g__aoc_output_seq {3}
    }
  }
  {
    \int_add:Nn \l__aoc_tmpa_int
    {
      \seq_item:Nn \g__aoc_output_seq {1}
    }
    \int_add:Nn \l__aoc_tmpa_int
    {
      \seq_item:Nn \g__aoc_output_seq {2}
    }
    \int_add:Nn \l__aoc_tmpa_int
    {
      \seq_item:Nn \g__aoc_output_seq {3}
    }
  }
  \int_use:N \l__aoc_tmpa_int
  \int_zero:N \l__aoc_tmpa_int
  \aoc_clear_outputs:
}

% Day 02: Rock Paper Scissors

% First version
\cs_new_protected_nopar:Npn \aoc_rps_score_a:n #1
{
  \group_begin:
  % Try to open the file
  \ior_open:NnTF \l__aoc_tmpa_ior {#1 .txt}
  {
    \int_zero:N \l__aoc_tmpc_int
    \ior_map_inline:Nn \l__aoc_tmpa_ior
    {
      \tl_set:Nn \l__aoc_tmpa_tl {##1}
      \tl_set:Nx \l__aoc_tmpb_tl {\tl_item:Nn \l__aoc_tmpa_tl {2}}
      \tl_set:Nx \l__aoc_tmpa_tl {\tl_item:Nn \l__aoc_tmpa_tl {1}}
      \int_set:Nn \l__aoc_tmpa_int {\exp_args:Nc `{\l__aoc_tmpa_tl} - 65}
      \int_set:Nn \l__aoc_tmpb_int {\exp_args:Nc `{\l__aoc_tmpb_tl} - 88}

      % Add the score for the choice of RPS
      \int_add:Nn \l__aoc_tmpc_int {\l__aoc_tmpb_int + 1}
      % Add the score for the round
      \int_set:Nn \l__aoc_tmpa_int { \int_mod:nn {\l__aoc_tmpb_int - \l__aoc_tmpa_int + 4} {3} }
      \int_add:Nn \l__aoc_tmpc_int {3 * \l__aoc_tmpa_int}
      
    }
    \int_gset_eq:NN \g__aoc_output_int \l__aoc_tmpc_int
    \ior_close:N \l__aoc_tmpa_ior
  }
  {
    % If there was a problem with the file
    \msg_warning:nnn { advent } { missing file } {#1}
  }
  \group_end:
}

% Second version
\cs_new_protected_nopar:Npn \aoc_rps_score_b:n #1
{
  \group_begin:
  % Try to open the file
  \ior_open:NnTF \l__aoc_tmpa_ior {#1 .txt}
  {
    \int_zero:N \l__aoc_tmpc_int
    \ior_map_inline:Nn \l__aoc_tmpa_ior
    {
      \tl_set:Nn \l__aoc_tmpa_tl {##1}
      \tl_set:Nx \l__aoc_tmpb_tl {\tl_item:Nn \l__aoc_tmpa_tl {2}}
      \tl_set:Nx \l__aoc_tmpa_tl {\tl_item:Nn \l__aoc_tmpa_tl {1}}
      \int_set:Nn \l__aoc_tmpa_int {\exp_args:Nc `{\l__aoc_tmpa_tl} - 65}
      \int_set:Nn \l__aoc_tmpb_int {\exp_args:Nc `{\l__aoc_tmpb_tl} - 88}

      % Add the score for the choice of outcome
      \int_add:Nn \l__aoc_tmpc_int {3*(\l__aoc_tmpb_int )}
      % Figure out the play
      \int_set:Nn \l__aoc_tmpb_int { \int_mod:nn { \l__aoc_tmpa_int + \l__aoc_tmpb_int + 2 }{3} }
      \int_add:Nn \l__aoc_tmpc_int { \l__aoc_tmpb_int + 1}
      
    }
    \int_gset_eq:NN \g__aoc_output_int \l__aoc_tmpc_int
    \ior_close:N \l__aoc_tmpa_ior
  }
  {
    % If there was a problem with the file
    \msg_warning:nnn { advent } { missing file } {#1}
  }
  \group_end:
}

\DeclareDocumentCommand \RPSScore {s m}
{
  \IfBooleanTF {#1}
  {
    \aoc_check_answer:nnn {int} {RPSScoreA}
    {
      \aoc_rps_score_a:n {#2}
    }
  }
  {
    \aoc_check_answer:nnn {int} {RPSScoreB}
    {
      \aoc_rps_score_b:n {#2}
    }
  }
  \int_use:N \g__aoc_output_int
  \aoc_clear_outputs:
}

\cs_new_protected_nopar:Npn \aoc_rucksack_one_line:n #1
{
  \group_begin:
  % Try to open the file
  \ior_open:NnTF \l__aoc_tmpa_ior {#1 .txt}
  {
    \int_zero:N \l__aoc_tmpb_int
    \ior_map_inline:Nn \l__aoc_tmpa_ior
    {
      \int_set:Nn \l__aoc_tmpa_int {\tl_count:n {##1}}
      \tl_set:Nx \l__aoc_tmpa_tl {\tl_range:nnn {##1} {1} {\l__aoc_tmpa_int/2}}
      \tl_set:Nx \l__aoc_tmpb_tl {\tl_range:nnn {##1} {\l__aoc_tmpa_int/2+1} {-1}}
      \tl_map_inline:Nn \l__aoc_tmpa_tl
      {
        \tl_if_in:VnT \l__aoc_tmpb_tl {####1}
        {
          \int_compare:nTF
          {
            \exp_args:Nc `{####1} > 96
          }
          {
            \int_add:Nn \l__aoc_tmpb_int {\exp_args:Nc `{####1} - 96}
          }
          {
            \int_add:Nn \l__aoc_tmpb_int {\exp_args:Nc `{####1} - 64 + 26}
          }
          \tl_map_break:
        }
      }
    }
    \int_gset_eq:NN \g__aoc_output_int \l__aoc_tmpb_int
    \ior_close:N \l__aoc_tmpa_ior
  }
  {
    % If there was a problem with the file
    \msg_warning:nnn { advent } { missing file } {#1}
  }
  \group_end:
}

\cs_new_protected_nopar:Npn \aoc_rucksack_three_lines:n #1
{
  \group_begin:
  % Try to open the file
  \ior_open:NnTF \l__aoc_tmpa_ior {#1 .txt}
  {
    \int_zero:N \l__aoc_tmpb_int
    \seq_clear:N \l__aoc_tmpa_seq
    \ior_map_inline:Nn \l__aoc_tmpa_ior
    {
      \seq_put_right:Nn \l__aoc_tmpa_seq {##1}
      \int_compare:nT { \seq_count:N \l__aoc_tmpa_seq = 3 }
      {
        \seq_pop_left:NN \l__aoc_tmpa_seq \l__aoc_tmpa_tl
        \seq_pop_left:NN \l__aoc_tmpa_seq \l__aoc_tmpb_tl
        \seq_pop_left:NN \l__aoc_tmpa_seq \l__aoc_tmpc_tl

        \tl_map_inline:Nn \l__aoc_tmpa_tl
        {
          \tl_if_in:VnT \l__aoc_tmpb_tl {####1}
          {
            \tl_if_in:VnT \l__aoc_tmpc_tl {####1}
            {
              \int_compare:nTF
              {
                \exp_args:Nc `{####1} > 96
              }
              {
                \int_add:Nn \l__aoc_tmpb_int {\exp_args:Nc `{####1} - 96}
              }
              {
                \int_add:Nn \l__aoc_tmpb_int {\exp_args:Nc `{####1} - 64 + 26}
              }
              \tl_map_break:
              
            }
          }
        }
      }
    }
    \int_gset_eq:NN \g__aoc_output_int \l__aoc_tmpb_int
    \ior_close:N \l__aoc_tmpa_ior
  }
  {
    % If there was a problem with the file
    \msg_warning:nnn { advent } { missing file } {#1}
  }
  \group_end:
}

\prop_gremove:Nn \g__aoc_answers_prop {Rucksack}
\NewDocumentCommand \Rucksack {s m}
{
  \IfBooleanTF {#1}
  {
    \aoc_check_answer:nnn {int} {RucksackOne}
    {
      \aoc_rucksack_one_line:n {#2}
    }
  }
  {
    \bool_gset_true:N \g__aoc_regenerate_next_bool
    \aoc_check_answer:nnn {int} {RucksackThree}
    {
      \aoc_rucksack_three_lines:n {#2}
    }
  }
  \int_use:N \g__aoc_output_int
  \aoc_clear_outputs:
}


% Camp Cleanup

\cs_new_protected_nopar:Npn \aoc_camp_cleanup_contained:n #1
{
  \group_begin:
  % Try to open the file
  \ior_open:NnTF \l__aoc_tmpa_ior {#1 .txt}
  {
    \int_zero:N \l__aoc_tmpe_int
    \ior_map_inline:Nn \l__aoc_tmpa_ior
    {
      \__aoc_camp_cleanup_aux:w ##1 \q_stop
      \bool_if:nT
      {
        (
        \int_compare_p:n {\l__aoc_tmpa_int <= \l__aoc_tmpc_int}
        &&
        \int_compare_p:n {\l__aoc_tmpb_int >= \l__aoc_tmpd_int}
        )
        ||
        (
        \int_compare_p:n {\l__aoc_tmpa_int >= \l__aoc_tmpc_int}
        &&
        \int_compare_p:n {\l__aoc_tmpb_int <= \l__aoc_tmpd_int}
        )
      }
      {
        \int_incr:N \l__aoc_tmpe_int
      }
    }      
    \ior_close:N \l__aoc_tmpa_ior
    \int_gset_eq:NN \g__aoc_output_int \l__aoc_tmpe_int
  }
  {
    % If there was a problem with the file
    \msg_warning:nnn { advent } { missing file } {#1}
  }
  \group_end:
}

\cs_new_protected_nopar:Npn \aoc_camp_cleanup_overlap:n #1
{
  \group_begin:
  % Try to open the file
  \ior_open:NnTF \l__aoc_tmpa_ior {#1 .txt}
  {
    \int_zero:N \l__aoc_tmpe_int
    \ior_map_inline:Nn \l__aoc_tmpa_ior
    {
      \__aoc_camp_cleanup_aux:w ##1 \q_stop
      \bool_if:nF
      {
        \int_compare_p:n {\l__aoc_tmpd_int < \l__aoc_tmpa_int}
        ||
        \int_compare_p:n {\l__aoc_tmpb_int < \l__aoc_tmpc_int}
      }
      {
        \int_incr:N \l__aoc_tmpe_int
      }
    }      
    \ior_close:N \l__aoc_tmpa_ior
    \int_gset_eq:NN \g__aoc_output_int \l__aoc_tmpe_int
  }
  {
    % If there was a problem with the file
    \msg_warning:nnn { advent } { missing file } {#1}
  }
  \group_end:
}

\cs_new_protected_nopar:Npn \__aoc_camp_cleanup_aux:w #1-#2,#3-#4 \q_stop
{
  \int_set:Nn \l__aoc_tmpa_int {#1}
  \int_set:Nn \l__aoc_tmpb_int {#2}
  \int_set:Nn \l__aoc_tmpc_int {#3}
  \int_set:Nn \l__aoc_tmpd_int {#4}
}

\NewDocumentCommand \CampCleanup {s m}
{
  \IfBooleanTF {#1}
  {
    \aoc_check_answer:nnn {int} {CampCleanupContain}
    {
      \aoc_camp_cleanup_contained:n {#2}
    }
  }
  {
    \bool_gset_true:N \g__aoc_regenerate_next_bool
    \aoc_check_answer:nnn {int} {CampCleanupOverlap}
    {
      \aoc_camp_cleanup_overlap:n {#2}
    }
  }
  \int_use:N \g__aoc_output_int
  \aoc_clear_outputs:
}


% Supply Stacks

\cs_new_protected_nopar:Npn \aoc_stack:nn #1#2
{
  \group_begin:
  \bool_set:Nn \l__aoc_tmpa_bool {\tl_if_empty_p:n {#1}}
  % Try to open the file
  \ior_open:NnTF \l__aoc_tmpa_ior {#2 .txt}
  {

    \int_step_inline:nnn {1} {9}
    {
      \tl_clear_new:c {l__aoc_stack_##1_tl}
    }

    \ior_str_map_inline:Nn \l__aoc_tmpa_ior
    {
      \tl_if_empty:nT {##1}
      {
        \ior_map_break:
      }
      \int_step_inline:nnn {1} {9}
      {
        \tl_put_right:cx {l__aoc_stack_####1_tl}
        {
          \str_item:nn {##1} {4*####1 - 2}
        }
      }
    }

    \int_step_inline:nnn {1} {9}
    {
      \tl_trim_spaces:c {l__aoc_stack_##1_tl}
      \tl_reverse:c {l__aoc_stack_##1_tl}
      \tl_set:cx {l__aoc_stack_##1_tl} {\tl_tail:v {l__aoc_stack_##1_tl}}
      \tl_reverse:c {l__aoc_stack_##1_tl}
    }

    \ior_map_inline:Nn \l__aoc_tmpa_ior
    {
      \aoc_stack_aux:w ##1 \q_stop
    }
    \ior_close:N \l__aoc_tmpa_ior
    \tl_gclear:N \g__aoc_output_tl
    \int_step_inline:nnn {1} {9}
    {
      \tl_gput_right:Nx \g__aoc_output_tl {\tl_head:v {l__aoc_stack_##1_tl}}
    }
  }
  {
    % If there was a problem with the file
    \msg_warning:nnn { advent } { missing file } {#2}
  }
  \group_end:
}

\cs_new_protected_nopar:Npn \aoc_stack_aux:w move~ #1 ~from~ #2 ~to~ #3~ \q_stop
{
  \tl_clear:N \l__aoc_tmpa_tl
  \prg_replicate:nn {#1}
  {
    \tl_put_left:Nx \l__aoc_tmpa_tl {\tl_head:v {l__aoc_stack_#2_tl}}
    \tl_set:cx {l__aoc_stack_#2_tl} {\tl_tail:v {l__aoc_stack_#2_tl}}
  }
  \bool_if:NT \l__aoc_tmpa_bool
  {
    \tl_reverse:N \l__aoc_tmpa_tl
  }
  \tl_put_left:cV {l__aoc_stack_#3_tl} \l__aoc_tmpa_tl
}

\NewDocumentCommand \SupplyStacks {s m}
{
  \IfBooleanTF {#1}
  {
    \bool_gset_true:N \g__aoc_regenerate_next_bool
    \aoc_check_answer:nnn {tl} {SupplyStack9000}
    {
      \aoc_stack:nn {a} {#2}
    }
  }
  {
    \bool_gset_true:N \g__aoc_regenerate_next_bool
    \aoc_check_answer:nnn {tl} {SupplyStack9001}
    {
      \aoc_stack:nn {} {#2}
    }
  }
  \tl_use:N \g__aoc_output_tl
  \aoc_clear_outputs:
}

% Tuning Trouble

\cs_new_protected_nopar:Npn \aoc_tuning:nn #1#2
{
  \group_begin:
  % Try to open the file
  \ior_open:NnTF \l__aoc_tmpa_ior {#2 .txt}
  {
    \int_step_inline:nnn {1} {#1}
    {
      \tl_clear_new:c {l__aoc_tmpa_##1_tl}
    }

    \int_zero:N \l__aoc_tmpa_int
    \ior_get:NN \l__aoc_tmpa_ior \l__aoc_tmpa_tl
    \tl_map_inline:Nn \l__aoc_tmpa_tl
    {
      \tl_set:cn {l__aoc_tmpa_ \int_eval:n {\int_mod:nn{\l__aoc_tmpa_int}{#1}} _tl} {##1}
      \bool_set_false:N \l__aoc_tmpa_bool
      \int_step_inline:nnn {1} {#1}
      {
        \tl_if_empty:cT {l__aoc_tmpa_ \int_eval:n {\int_mod:nn{####1}{#1}} _tl}
        {
          \bool_set_true:N \l__aoc_tmpa_bool
        }
      }
      \int_step_inline:nnn {1}{#1-1}
      {
        \int_step_inline:nnn {####1+1}{#1}
        {
          \tl_if_eq:ccT
          {l__aoc_tmpa_ \int_eval:n {\int_mod:nn{####1}{#1}} _tl}
          {l__aoc_tmpa_ \int_eval:n {\int_mod:nn{########1}{#1}} _tl}
          {
            \bool_set_true:N \l__aoc_tmpa_bool
          }
        }
      }
      \bool_if:NF \l__aoc_tmpa_bool
      {
        \tl_map_break:
      }
      \int_incr:N \l__aoc_tmpa_int
    }
    \int_incr:N \l__aoc_tmpa_int
    \int_gset_eq:NN \g__aoc_output_int \l__aoc_tmpa_int
  }
  {
    % If there was a problem with the file
    \msg_warning:nnn { advent } { missing file } {#1}
  }
  \group_end:
}


\NewDocumentCommand \TuningTrouble {s m}
{
  \IfBooleanTF {#1}
  {
    \aoc_check_answer:nnn {int} {TuningTrouble4}
    {
      \aoc_tuning:nn {4} {#2}
    }
  }
  {
    \aoc_check_answer:nnn {int} {TuningTrouble14}
    {
      \aoc_tuning:nn {14} {#2}
    }
  }
  \int_use:N \g__aoc_output_int
  \aoc_clear_outputs:
}

% Device Left on Space

\cs_new_protected_nopar:Npn \aoc_device_space:nn #1#2
{
  \group_begin:
  % Try to open the file
  \ior_open:NnTF \l__aoc_tmpa_ior {#2 .txt}
  {
    
    \seq_clear:N \l__aoc_tmpa_seq
    \int_zero:N \l__aoc_tmpa_int
    \prop_clear:N \l__aoc_tmpa_prop
    
    \ior_map_inline:Nn \l__aoc_tmpa_ior
    {
      \tl_set:Nn \l__aoc_tmpa_tl {##1}
      \tl_if_head_eq_catcode:nNTF {##1} \c_math_toggle_token
      {
        \tl_set:Nx \l__aoc_tmpa_tl {\tl_tail:N \l__aoc_tmpa_tl}
        \tl_set:Nx \l__aoc_tmpb_tl {
          \tl_item:Nn \l__aoc_tmpa_tl {1}
          \tl_item:Nn \l__aoc_tmpa_tl {2}
        }
        \tl_if_eq:VnT \l__aoc_tmpb_tl {cd}
        {
          \tl_set:Nx \l__aoc_tmpa_tl {\tl_tail:N \l__aoc_tmpa_tl}
          \tl_set:Nx \l__aoc_tmpa_tl {\tl_tail:N \l__aoc_tmpa_tl}
          \tl_trim_spaces:N \l__aoc_tmpa_tl
          \tl_if_eq:VnTF \l__aoc_tmpa_tl {..}
          {
            % This is the signal that we're done with a directory
            % Store the current size in the prop for that directory
            \prop_put:NxV \l__aoc_tmpa_prop
            {
              \seq_use:Nn \l__aoc_tmpa_seq {-}
            }
            \l__aoc_tmpa_int

            % Step up one level in the tree
            \seq_pop_right:NN \l__aoc_tmpa_seq \l__aoc_tmpc_tl

            % Add the current size to the parent directory
            \prop_get:NxN \l__aoc_tmpa_prop {\seq_use:Nn \l__aoc_tmpa_seq {-}} \l__aoc_tmpd_tl
            \int_add:Nn \l__aoc_tmpa_int
            {
              \l__aoc_tmpd_tl
            }
          }
          {
            % Store the current size in the prop for this directory
            \prop_put:NxV \l__aoc_tmpa_prop
            {
              \seq_use:Nn \l__aoc_tmpa_seq {-}
            }
            \l__aoc_tmpa_int

            % Descend one more step
            \seq_put_right:NV \l__aoc_tmpa_seq \l__aoc_tmpa_tl
            % Clear the size counter
            \int_zero:N \l__aoc_tmpa_int
            % Zero the size store
            \prop_put:Nxn \l__aoc_tmpa_prop {\seq_use:Nn \l__aoc_tmpa_seq {-}} {0}
          }
        }
      }
      {
        \tl_if_head_eq_catcode:nNT {##1} \c_catcode_other_token
        {
          % digit, increment the current size
          \seq_set_split:Nnn \l__aoc_tmpb_seq {~} {##1}
          \int_add:Nn \l__aoc_tmpa_int {\seq_item:Nn \l__aoc_tmpb_seq {1}}
        }
      }
    }
    \ior_close:N \l__aoc_tmpa_ior

    \prg_replicate:nn {\seq_count:N \l__aoc_tmpa_seq}
    {
      \prop_put:NxV \l__aoc_tmpa_prop
      {
        \seq_use:Nn \l__aoc_tmpa_seq {-}
      }
      \l__aoc_tmpa_int

      % Step up one level in the tree
      \seq_pop_right:NN \l__aoc_tmpa_seq \l__aoc_tmpc_tl

      % Add the current size to the parent directory
      \prop_get:NxN \l__aoc_tmpa_prop {\seq_use:Nn \l__aoc_tmpa_seq {-}} \l__aoc_tmpd_tl
      \int_add:Nn \l__aoc_tmpa_int
      {
        \l__aoc_tmpd_tl
      }
    }

    \tl_if_eq:nnTF {#1}{A}
    {
      \int_zero:N \l__aoc_tmpa_int
      \prop_map_inline:Nn \l__aoc_tmpa_prop
      {
        \int_compare:nT {##2 <= 100000 }
        {
          \int_add:Nn \l__aoc_tmpa_int {##2}
        }
      }
      \int_gset_eq:NN \g__aoc_output_int \l__aoc_tmpa_int
    }
    {

      \prop_get:NnN \l__aoc_tmpa_prop {/} \l__aoc_tmpa_tl
      \int_set:Nn \l__aoc_tmpb_int {30000000 - (70000000 - \l__aoc_tmpa_tl)}

      \int_set:Nn \l__aoc_tmpc_int {\l__aoc_tmpa_tl}
      \prop_map_inline:Nn \l__aoc_tmpa_prop
      {
        \bool_if:nT
        {
          \int_compare_p:n {##2 >= \l__aoc_tmpb_int }
          &&
          \int_compare_p:n {##2 < \l__aoc_tmpc_int }
        }        
        {
          \int_set:Nn \l__aoc_tmpc_int {##2}
        }
      }

      \int_gset_eq:NN \g__aoc_output_int \l__aoc_tmpc_int
    }
  }
  {
    % If there was a problem with the file
    \msg_warning:nnn { advent } { missing file } {#1}
  }
  \group_end:
}

\NewDocumentCommand \DeviceSpace {s m}
{
  \IfBooleanTF {#1}
  {
    \aoc_check_answer:nnn {int} {DeviceSpaceA}
    {
      \aoc_device_space:nn {A} {#2}
    }
  }
  {
    \aoc_check_answer:nnn {int} {DeviceSpaceB}
    {
      \aoc_device_space:nn {B} {#2}
    }
  }
  \int_use:N \g__aoc_output_int
  \aoc_clear_outputs:
}

% Treetop Tree House

\grid_new:Nnn \g__aoc_trees_grid {99}{99}
\grid_new:Nnn \g__aoc_visible_grid {99}{99}

\cs_new_protected_nopar:Npn \aoc_treetop:n #1
{
  \group_begin:
  % Try to open the file
  \ior_open:NnTF \l__aoc_tmpa_ior {#1 .txt}
  {
    \grid_gclear:N \g__aoc_trees_grid
    \grid_gclear:N \g__aoc_visible_grid
    \int_zero:N \l__aoc_tmpa_int
    \int_zero:N \l__aoc_tmpb_int
    % Read in the data from the file and create an array from it
    \ior_map_inline:Nn \l__aoc_tmpa_ior
    {
      \int_incr:N \l__aoc_tmpa_int
      \int_zero:N \l__aoc_tmpb_int
      \tl_map_inline:nn {##1}
      {
        \int_incr:N \l__aoc_tmpb_int
        \grid_gset:NVVn \g__aoc_trees_grid
        \l__aoc_tmpa_int \l__aoc_tmpb_int {####1}
      }
    }
    \ior_close:N \l__aoc_tmpa_ior

    % Now iterate through each row and column and find how many trees
    % are visible from each direction
    \int_step_inline:nnn {1} {99} {
      \int_set:Nn \l__aoc_tmpb_int {-1}
      \int_set:Nn \l__aoc_tmpc_int {-1}
      \int_set:Nn \l__aoc_tmpd_int {-1}
      \int_set:Nn \l__aoc_tmpe_int {-1}
      \int_step_inline:nnn {1} {99} {
        \aoc_treetop_aux:Nnn \l__aoc_tmpb_int {##1}{####1}
        \aoc_treetop_aux:Nnn \l__aoc_tmpc_int {####1}{##1}
        \aoc_treetop_aux:Nnn \l__aoc_tmpd_int {##1}{100 - ####1}
        \aoc_treetop_aux:Nnn \l__aoc_tmpe_int {100 - ####1}{##1}
      }
    }
    \int_zero:N \l__aoc_tmpa_int
    \int_step_inline:nnn {1} {99} {
      \int_step_inline:nnn {1} {99} {
        \int_add:Nn \l__aoc_tmpa_int
        {
          \grid_item:Nnn \g__aoc_visible_grid {##1} {####1}
        }
      }
    }
    \int_gset_eq:NN \g__aoc_output_int \l__aoc_tmpa_int
  }
  {
    % If there was a problem with the file
    \msg_warning:nnn { advent } { missing file } {#1}
  }
  \group_end:
}

\cs_new_protected_nopar:Npn \aoc_treetop_aux:Nnn #1#2#3
{
  \int_compare:nT
  {
    \grid_item:Nnn \g__aoc_trees_grid {#2} {#3}
    >
    #1
  }
  {
    \grid_gset:Nnnn \g__aoc_visible_grid {#2} {#3} {1}
    \int_set:Nn #1
    {
      \grid_item:Nnn \g__aoc_trees_grid {#2} {#3}
    }
  }
}

% We'll use four grids to store the directions

\int_new:N \g__aoc_grid_size_int
\int_set:Nn \g__aoc_grid_size_int {99} % {5}
\grid_new:NVV \g__aoc_left_grid \g__aoc_grid_size_int \g__aoc_grid_size_int
\grid_new:NVV \g__aoc_right_grid \g__aoc_grid_size_int \g__aoc_grid_size_int
\grid_new:NVV \g__aoc_up_grid \g__aoc_grid_size_int \g__aoc_grid_size_int
\grid_new:NVV \g__aoc_down_grid \g__aoc_grid_size_int \g__aoc_grid_size_int

\cs_new_protected_nopar:Npn \aoc_scenic_treetop:n #1
{
  \group_begin:
  % Try to open the file
  \ior_open:NnTF \l__aoc_tmpa_ior {#1 .txt}
  {
    \grid_gclear:N \g__aoc_trees_grid
    \grid_gclear:N \g__aoc_visible_grid
    \int_zero:N \l__aoc_tmpa_int
    \int_zero:N \l__aoc_tmpb_int
    \int_zero:N \l__aoc_tmpc_int
    % Read in the data from the file and create an array from it
    \ior_map_inline:Nn \l__aoc_tmpa_ior
    {
      \int_incr:N \l__aoc_tmpa_int
      \int_zero:N \l__aoc_tmpb_int
      \tl_map_inline:nn {##1}
      {
        \int_incr:N \l__aoc_tmpb_int
        \grid_gset:NVVn \g__aoc_trees_grid
        \l__aoc_tmpa_int \l__aoc_tmpb_int {####1}
        % Initialise the distance grids so that by default they contain the distances to the edges of the grid.
        \grid_gset:NVVn \g__aoc_left_grid \l__aoc_tmpa_int \l__aoc_tmpb_int
        {\l__aoc_tmpb_int - 1} % number of trees to the left
        \grid_gset:NVVn \g__aoc_right_grid \l__aoc_tmpa_int \l__aoc_tmpb_int
        {(\g__aoc_grid_size_int - \l__aoc_tmpb_int)} % number of trees to the right
        \grid_gset:NVVn \g__aoc_up_grid \l__aoc_tmpa_int \l__aoc_tmpb_int
        {(\l__aoc_tmpa_int - 1)} % number of trees above
        \grid_gset:NVVn \g__aoc_down_grid \l__aoc_tmpa_int \l__aoc_tmpb_int
        {(\g__aoc_grid_size_int - \l__aoc_tmpa_int)} % number of trees below
      }
    }
    \ior_close:N \l__aoc_tmpa_ior
%    \grid_show:N \g__aoc_left_grid
%    \grid_show:N \g__aoc_right_grid
%    \grid_show:N \g__aoc_up_grid
%    \grid_show:N \g__aoc_down_grid

    \iow_term:n {Finished~ reading~ file}

    % As we step along each row and column, we keep track of the location of the most recently found tree of the given height.
    \int_step_inline:nnnn {9} {-1} {0} { % Iterate through the heights
      % Iterate through the rows and columns
      \iow_term:n {Parsing~ height~ ##1}
      \int_step_inline:nnn {1} {\g__aoc_grid_size_int} {
        % These keep track of our current tree of the given height
        \int_set:Nn \l__aoc_tmpb_int {1}
        \int_set:Nn \l__aoc_tmpc_int {1}
        \int_set:Nn \l__aoc_tmpd_int {\g__aoc_grid_size_int}
        \int_set:Nn \l__aoc_tmpe_int {\g__aoc_grid_size_int}
        % Iterate along each row and column, from each direction
        \int_step_inline:nnn {1} {\g__aoc_grid_size_int} {
          
          \aoc_scenic_treetop_aux:NNnnnn
          \g__aoc_left_grid
          \l__aoc_tmpb_int {##1} {0} {####1}{########1}
          
          \aoc_scenic_treetop_aux:NNnnnn
          \g__aoc_up_grid
          \l__aoc_tmpc_int {##1} {1} {########1}{####1}
          
          \aoc_scenic_treetop_aux:NNnnnn
          \g__aoc_right_grid
          \l__aoc_tmpd_int {##1} {0} {####1}{\g__aoc_grid_size_int+1 - ########1}
          
          \aoc_scenic_treetop_aux:NNnnnn
          \g__aoc_down_grid
          \l__aoc_tmpe_int {##1} {1} {\g__aoc_grid_size_int+1 - ########1}{####1}
        }
      }
    }
%    \grid_show:N \g__aoc_left_grid
%    \grid_show:N \g__aoc_right_grid
%    \grid_show:N \g__aoc_up_grid
%    \grid_show:N \g__aoc_down_grid
    \int_zero:N \l__aoc_tmpa_int
    \int_step_inline:nnn {1} {\g__aoc_grid_size_int} {
      \int_step_inline:nnn {1} {\g__aoc_grid_size_int} {
        \int_set:Nn \l__aoc_tmpa_int
        {
          \int_max:nn {\l__aoc_tmpa_int}
          {
            \grid_item:Nnn \g__aoc_left_grid {##1} {####1}
            *
            \grid_item:Nnn \g__aoc_right_grid {##1} {####1}
            *
            \grid_item:Nnn \g__aoc_up_grid {##1} {####1}
            *
            \grid_item:Nnn \g__aoc_down_grid {##1} {####1}
          }
        }
      }
    }
    \int_gset_eq:NN \g__aoc_output_int \l__aoc_tmpa_int
  }
  {
    % If there was a problem with the file
    \msg_warning:nnn { advent } { missing file } {#1}
  }
  \group_end:
}

% Parameters:
% Grid to save the distances in
% Location of most recent tree of given height
% Current height
% Direction (horizontal/vertical)
% Coordinates
\cs_new_protected_nopar:Npn \aoc_scenic_treetop_aux:NNnnnn #1#2#3#4#5#6
{
  % Is the current tree of the right height?
  \int_compare:nT { \grid_item:Nnn \g__aoc_trees_grid {#5}{#6} = #3}
  {
    % yes, current tree is the current height
    \int_compare:nTF {#4 = 0}
    { % horizontal
      \grid_gset:Nnnn #1 {#5}{#6}
      {
        \int_abs:n {#6 - #2}
      }
    }
    { % vertical
      \grid_gset:Nnnn #1 {#5}{#6}
      {
        \int_abs:n {#5 - #2}
      }
    }
  }
  \int_compare:nT { \grid_item:Nnn \g__aoc_trees_grid {#5}{#6} >= #3}
  {
    % current tree is at least the current height, so we update the location register
    \int_compare:nTF {#4 = 0}
    { % horizontal
      \int_set:Nn #2 { #6}
    }
    { % vertical
      \int_set:Nn #2 { #5}
    }
  }
}


\NewDocumentCommand \Treetop {s m}
{
  \IfBooleanTF {#1}
  {
    \aoc_check_answer:nnn {int} {Treetop}
    {
      \aoc_treetop:n {#2}
    }
  }
  {
    \aoc_check_answer:nnn {int} {Scenic}
    {
      \aoc_scenic_treetop:n {#2}
    }
  }
  \int_use:N \g__aoc_output_int
  \aoc_clear_outputs:
}


% Rope Bridge

\cs_new_protected_nopar:Npn \aoc_ropebridge:n #1
{
  \group_begin:
  % Try to open the file
  \ior_open:NnTF \l__aoc_tmpa_ior {#1 .txt}
  {
    \seq_clear:N \l__aoc_tmpa_seq % locations of second knot
    \seq_clear:N \l__aoc_tmpf_seq % locations of last knot
    \seq_clear:N \l__aoc_tmpb_seq % x--coordinates
    \seq_clear:N \l__aoc_tmpc_seq % y--coordinates
    \prg_replicate:nn {10}
    {
      \seq_put_right:Nn \l__aoc_tmpb_seq {0}
      \seq_put_right:Nn \l__aoc_tmpc_seq {0}
    }
    \iow_term:n {Processing~file}
    \int_zero:N \l__aoc_tmpa_int
    \int_set:Nn \l__aoc_tmpb_int {\sys_timer:}
    \ior_map_inline:Nn \l__aoc_tmpa_ior
    {
      \aoc_ropebridge_aux:w ##1 \q_stop
      \int_incr:N \l__aoc_tmpa_int
      \int_compare:nT {\int_mod:nn {\l__aoc_tmpa_int} {20} = 0}
      {
        \iow_term:x {Processed~ line~ \int_use:N \l__aoc_tmpa_int\c_space_tl~ in~ \int_eval:n {(\sys_timer: - \l__aoc_tmpb_int)/65536}}
        \int_set:Nn \l__aoc_tmpb_int {\sys_timer:}
      }
    }
    \ior_close:N \l__aoc_tmpa_ior
    \iow_term:n {File~ processed}
    \seq_gclear:N \g__aoc_output_seq
    \seq_gput_right:Nx \g__aoc_output_seq
    {\seq_count:N \l__aoc_tmpa_seq}
    \seq_gput_right:Nx \g__aoc_output_seq
    {\seq_count:N \l__aoc_tmpf_seq}
  }
  {
    % If there was a problem with the file
    \msg_warning:nnn { advent } { missing file } {#1}
  }
  \group_end:
}

\tl_const:Nn \c__aoc_R_tl {R}
\tl_const:Nn \c__aoc_L_tl {L}
\tl_const:Nn \c__aoc_D_tl {D}
\tl_const:Nn \c__aoc_U_tl {U}
\cs_new_protected_nopar:Npn \aoc_ropebridge_aux:w #1#2 \q_stop
{
  % Save the motion to a token list for comparison
  \tl_set:Nn \l__aoc_tmpa_tl {#1}
  \prg_replicate:nn {#2}
  {
    % Clear the scratch sequences for the coordinates
    \seq_clear:N \l__aoc_tmpd_seq
    \seq_clear:N \l__aoc_tmpe_seq
    % Move the head
    \tl_case:Nn \l__aoc_tmpa_tl
    {
      \c__aoc_R_tl
      {
        \seq_put_right:Nx \l__aoc_tmpd_seq
        {
          \int_eval:n {\seq_item:Nn \l__aoc_tmpb_seq {1} + 1}
        }
        \seq_put_right:Nx \l__aoc_tmpe_seq
        {
          \seq_item:Nn \l__aoc_tmpc_seq {1}
        }
      }
      \c__aoc_L_tl
      {
        \seq_put_right:Nx \l__aoc_tmpd_seq
        {
          \int_eval:n {\seq_item:Nn \l__aoc_tmpb_seq {1} - 1}
        }
        \seq_put_right:Nx \l__aoc_tmpe_seq
        {
          \seq_item:Nn \l__aoc_tmpc_seq {1}
        }
      }
      \c__aoc_U_tl
      {
        \seq_put_right:Nx \l__aoc_tmpd_seq
        {
          \seq_item:Nn \l__aoc_tmpb_seq {1}
        }
        \seq_put_right:Nx \l__aoc_tmpe_seq
        {
          \int_eval:n {\seq_item:Nn \l__aoc_tmpc_seq {1} + 1}
        }
      }
      \c__aoc_D_tl
      {
        \seq_put_right:Nx \l__aoc_tmpd_seq
        {
          \seq_item:Nn \l__aoc_tmpb_seq {1}
        }
        \seq_put_right:Nx \l__aoc_tmpe_seq
        {
          \int_eval:n {\seq_item:Nn \l__aoc_tmpc_seq {1} - 1}
        }
      }
    }
    \int_step_inline:nnn {2} {10}
    {
      % Does the next knot need to move?
      % Compare the l^infty distance
      \int_compare:nTF
      {
        \int_max:nn
        {
          \int_abs:n {
            \seq_item:Nn \l__aoc_tmpb_seq {##1}
            -
            \seq_item:Nn \l__aoc_tmpd_seq {##1 - 1}
          }
        }
        {
          \int_abs:n {
            \seq_item:Nn \l__aoc_tmpc_seq {##1}
            -
            \seq_item:Nn \l__aoc_tmpe_seq {##1 - 1}
          }
        }
        > 1
      }
      {
        % move the knot towards the previous one
        \seq_put_right:Nx \l__aoc_tmpd_seq
        {
          \seq_item:Nn \l__aoc_tmpb_seq {##1}
          +
          \int_sign:n
          {
            \seq_item:Nn \l__aoc_tmpd_seq {##1 - 1}
            -
            \seq_item:Nn \l__aoc_tmpb_seq {##1}
          }
        }
        \seq_put_right:Nx \l__aoc_tmpe_seq
        {
          \seq_item:Nn \l__aoc_tmpc_seq {##1}
          +
          \int_sign:n
          {
            \seq_item:Nn \l__aoc_tmpe_seq {##1 - 1}
            -
            \seq_item:Nn \l__aoc_tmpc_seq {##1}
          }
        }
      }
      {
        % No movement, copy the coordinates
        \seq_put_right:Nx \l__aoc_tmpd_seq
        {
          \seq_item:Nn \l__aoc_tmpb_seq {##1}
        }
        \seq_put_right:Nx \l__aoc_tmpe_seq
        {
          \seq_item:Nn \l__aoc_tmpc_seq {##1}
        }
      }
    }
    \seq_set_eq:NN \l__aoc_tmpb_seq \l__aoc_tmpd_seq
    \seq_set_eq:NN \l__aoc_tmpc_seq \l__aoc_tmpe_seq
    \seq_if_in:NxF \l__aoc_tmpa_seq {
      \seq_item:Nn \l__aoc_tmpb_seq {2},
      \seq_item:Nn \l__aoc_tmpc_seq {2}
    }
    {
      \seq_put_right:Nx \l__aoc_tmpa_seq {
        \seq_item:Nn \l__aoc_tmpb_seq {2},
        \seq_item:Nn \l__aoc_tmpc_seq {2}
      }
    }
    \seq_if_in:NxF \l__aoc_tmpf_seq {
      \seq_item:Nn \l__aoc_tmpb_seq {10},
      \seq_item:Nn \l__aoc_tmpc_seq {10}
    }
    {
      \seq_put_right:Nx \l__aoc_tmpf_seq {
        \seq_item:Nn \l__aoc_tmpb_seq {10},
        \seq_item:Nn \l__aoc_tmpc_seq {10}
      }
    }
  }
}

\prop_gremove:Nn \g__aoc_answers_prop {RopeBridgeTail}
\prop_gremove:Nn \g__aoc_answers_prop {SupplyStack}
\prop_gremove:Nn \g__aoc_answers_prop {TuningTrouble}
\prop_gremove:Nn \g__aoc_answers_prop {DeviceSpace}


\NewDocumentCommand \RopeBridge {s m}
{
  \bool_gset_true:N \g__aoc_regenerate_next_bool
  \aoc_check_answer:nnn {seq} {RopeBridge}
  {
    \aoc_ropebridge:n {#2}
  }
  \IfBooleanTF {#1}
  {
    \seq_item:Nn \g__aoc_output_seq {1}
  }
  {
    \seq_item:Nn \g__aoc_output_seq {2}
  }
  \aoc_clear_outputs:
}



% Template

\cs_new_protected_nopar:Npn \aoc_template:n #1
{
  \group_begin:
  % Try to open the file
  \ior_open:NnTF \l__aoc_tmpa_ior {#1 .txt}
  {
    \ior_map_inline:Nn \l__aoc_tmpa_ior
    {
    }
    \ior_close:N \l__aoc_tmpa_ior
  }
  {
    % If there was a problem with the file
    \msg_warning:nnn { advent } { missing file } {#1}
  }
  \group_end:
}

\NewDocumentCommand \Template {s m}
{
  \IfBooleanTF {#1}
  {
    \bool_gset_true:N \g__aoc_regenerate_next_bool
    \aoc_check_answer:nnn {tl} {Template}
    {
      %
    }
  }
  {
    \bool_gset_true:N \g__aoc_regenerate_next_bool
    \aoc_check_answer:nnn {tl} {Template}
    {
      %
    }
  }
  \tl_use:N \g__aoc_output_tl
  \aoc_clear_outputs:
}


\ExplSyntaxOff
